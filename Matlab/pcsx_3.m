%Copyright 2017 Fan Yifeng. All rights reserved.

%rho def
rho = 180/pi;
%original data
r = 10;
x_A = 3143.237;
y_A = 5260.334;
x_B = 4609.361;
y_B = 5025.696;
x_C = 7657.661;
y_C = 5071.897;
x_D = 4157.197;
y_D = 8853.254;
s_AB = 1484.781;
s_BC = 3048.650;
alpha_AB = dms2degrees([350 54 27.0]);
alpha_BC = dms2degrees([0 52 06.0]);
alpha_DE = dms2degrees([109 31 44.9]);
L = [dms2degrees([44 05 44.8]);dms2degrees([93 10 43.1]);dms2degrees([42 43 27.2]);dms2degrees([76 51 40.7]);dms2degrees([28 45 20.9]);dms2degrees([74 22 55.1]);dms2degrees([127 25 56.1]);dms2degrees([201 57 34.0]);dms2degrees([168 01 45.2]);2185.070;1522.853;3082.621;1500.017;1009.021];
%calc P matrix
szL = size(L);
P = zeros(szL(1));
for i = 1:szL(1)
    if(i<10)
        P(i,i) = 1;
    else
        P(i,i) = (2.5/(15*L(i,1)/1000))^2;
    end
end
%approximate values calc
X0 = [
((x_B*cotd(L(5,1)) + x_C*cotd(L(4,1)) - (y_C - y_B))/(cotd(L(4,1)) + cotd(L(5,1))) + (x_A*cotd(L(2,1)) + x_B*cotd(L(1,1)) - (y_B - y_A))/(cotd(L(1,1)) + cotd(L(2,1))))/2;
((y_B*cotd(L(5,1)) + y_C*cotd(L(4,1)) + (x_C - x_B))/(cotd(L(4,1)) + cotd(L(5,1))) + (y_A*cotd(L(2,1)) + y_B*cotd(L(1,1)) + (x_B - x_A))/(cotd(L(1,1)) + cotd(L(2,1))))/2;
x_D + L(14,1)*cosd(360 - L(9,1) + alpha_DE);
y_D + L(14,1)*sind(360 - L(9,1) + alpha_DE);
];
L0 = [
0;0;0;0;0;0;0;0;0;
sqrt((X0(1,1)- x_A)^2 + (X0(2,1)- y_A)^2);
sqrt((X0(1,1)- x_B)^2 + (X0(2,1)- y_B)^2);
sqrt((X0(1,1)- x_C)^2 + (X0(2,1)- y_C)^2);
sqrt((X0(1,1)- X0(3,1))^2 + (X0(2,1)- X0(4,1))^2);
sqrt((X0(3,1) - x_D)^2 + (X0(4,1) - y_D)^2);
];
%B matrix calc
B = [
(rho*(X0(2,1) - y_A)/(L0(10,1)^2)) (-rho*(X0(1,1) - x_A)/(L0(10,1)^2)) 0 0;
(rho*(X0(2,1) - y_B)/(L0(11,1)^2)) (-rho*(X0(1,1) - x_B)/(L0(11,1)^2)) 0 0;
((rho*(y_B - X0(2,1))/(L0(11,1)^2) - rho*(y_A - X0(2,1))/(L0(10,1)^2))) -(-(rho*(x_B - X0(1,1))/(L0(11,1)^2) + rho*(x_A - X0(1,1))/(L0(10,1)^2))) 0 0;
-(rho*(X0(2,1) - y_B)/(L0(11,1)^2)) (rho*(X0(1,1) - x_B)/(L0(11,1)^2)) 0 0;
(rho*(X0(2,1) - y_C)/(L0(12,1)^2)) -(rho*(X0(1,1) - x_C)/(L0(12,1)^2)) 0 0;
(rho*(y_C - X0(2,1))/(L0(12,1)^2) - rho*(y_B - X0(2,1))/(L0(11,1)^2)) -(-rho*(x_C - X0(1,1))/(L0(12,1)^2) + rho*(x_B - X0(1,1))/(L0(11,1)^2)) 0 0;
(rho*(y_C - X0(2,1))/(L0(12,1)^2) - rho*(X0(4,1) - X0(2,1))/(L0(13,1)^2)) -(-rho*(X0(3,1) - X0(1,1))/(L0(13,1)^2) + rho*(X0(3,1) - X0(1,1))/(L0(13,1)^2)) (rho*(X0(4,1) - y_B)/(L0(13,1)^2)) -(rho*(X0(3,1) - X0(1,1))/(L0(13,1)^2));
(rho*(X0(2,1) - X0(4,1))/(L0(13,1)^2)) -(rho*(X0(1,1) - X0(3,1))/(L0(13,1)^2)) (rho*(X0(2,1) - X0(4,1))/(L0(13,1)^2) - rho*(y_D - X0(4,1))/(L0(14,1)^2)) -(-rho*(X0(1,1) - X0(3,1))/(L0(13,1)^2) + rho*(x_D - X0(3,1))/(L0(14,1)^2));
0 0 -(rho*(X0(4,1) - y_D)/(L0(14,1)^2)) (rho*(X0(3,1) - x_D)/(L0(14,1)^2));
%
(X0(1,1) - x_A)/L0(10,1) (X0(2,1) - y_A)/L0(10,1) 0 0;
(X0(1,1) - x_B)/L0(11,1) (X0(2,1) - y_B)/L0(11,1) 0 0;
-(x_C - X0(1,1))/L0(12,1) -(y_C - X0(2,1))/L0(12,1) 0 0;
(X0(1,1) - X0(3,1))/L0(13,1) (X0(2,1) - X0(4,1))/L0(13,1) -(X0(1,1) - X0(3,1))/L0(13,1) -(X0(2,1) - X0(4,1))/L0(13,1);
0 0 (X0(3,1) - x_D)/L0(14,1) (X0(4,1) - y_D)/L0(14,1);
];
B=[-0.541 0.773 0 0;1.323 -0.288 0 0;-0.782 -0.485 0 0;-1.323 0.288 0 0;0.313 0.591 0 0;1.01 -0.879 0 0;1.669 0.819 -1.356 -0.128;-1.356 -0.228 3.099 1.296;0 0 -1.743 -1.068;0.819 0.574 0 0;0.212 0.977 0 0;-0.884 0.468 0 0;0.166 -0.986 -0.166 0.986;0 0 0.552 -0.853];
%l matrix calc
l = [
(atand((X0(2,1) - y_A)/(X0(1,1) - x_A)) - alpha_AB - L(1,1) + 360);
(atand((X0(2,1) - y_B)/(X0(1,1) - x_B)) - (alpha_AB - 180) + L(2,1));
(-atand((y_B - X0(2,1))/(x_B - X0(1,1))) + atand((y_A - X0(2,1))/(x_A - X0(1,1))) + L(3,1));
(-atand((X0(2,1) - y_B)/(X0(1,1) - x_B)) + alpha_BC + L(4,1));
(atand((X0(2,1) - y_C)/(X0(1,1) - x_C)) - (alpha_BC + 180) + L(5,1));
(-atand((y_C - X0(2,1))/(x_C - X0(1,1))) + atand((y_B - X0(2,1))/(x_B - X0(1,1))) + L(6,1));
(-atand((y_C - X0(2,1))/(x_C - X0(1,1))) + atand((X0(4,1) - X0(2,1))/(X0(3,1) - X0(1,1))) - L(7,1) + 360);
(-atand((X0(2,1) - X0(4,1))/(X0(1,1) - X0(3,1))) + atand((y_D - X0(4,1))/(x_D - X0(3,1))) - L(8,1) + 360);
(-atand((X0(4,1) - y_D)/(X0(3,1) - x_D)) + alpha_DE - L(9,1) +360);
(L(10,1) - L0(10,1));
(L(11,1) - L0(11,1));
(L(12,1) - L0(12,1));
(L(13,1) - L0(13,1));
(L(14,1) - L0(14,1));
];
l = [-2.62;1.38;-3.66;1.42;1.76;-6.48;17.72;-0.46;0;5.365;2.576;-1.004;8.364;-0.046];
%adjust
NBB = B'*P*B;
W = B'*P*l;
x = inv(NBB)*W;
Xad = X0 + x;
QXX = inv(NBB);
V = B*x - l;
Lad = L + V;
%error
StdErr0 = sqrt(V'*P*V/r);
QLL = B*QXX*B';
StdErrX =zeros(4,1);
for i = 1:4
    StdErrX(i,1) = StdErr0*sqrt(QXX(i,i));
end
StdErrP1 = sqrt(StdErrX(1,1)^2 + StdErrX(2,1)^2);
StdErrP2 = sqrt(StdErrX(3,1)^2 + StdErrX(4,1)^2);
StdErrL = zeros(14,1);
for i = 1:14
    StdErrL(i,1) = StdErr0*sqrt(QLL(i,i));
end


